<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon16.png" type="image/png">
    <meta name="og:site_name" content="CyberYoshi64's website">
    <meta name="theme-color" content="#00C0FF" data-react-helmet="true">
    <meta name="description" content="Read info from the CYX crash dump">
    <title>PTCSysDump Viewer</title>
    <style>
        @font-face {
            font-family: std;
            src: url("/assets/fonts/CTRNTLG-DB.ttf") format("truetype");
        }
        body {
            background: #000;
            color: white;
            font-family: std, 'MS PGothic', sans-serif!important;
            font-size: 12pt;
            margin: 10vh 15vw;
        }
        code {
            font-size: 12pt;
            font-family: "Cascadia Mono", "Lucida Console", "MS Gothic", monospace!important;
        }
        table {
            border-radius: 10pt;
            background: linear-gradient(160deg, #222 0%, #000 100%);
        }

        table, td {
            overflow-x: clip;
            max-width: 70vw;
            padding: 0px;
        }

        td {
            max-width: calc(70vw - 6px);
            line-height: 1.25;
        }

        .innertd {
            padding: 0px 8pt;
        }
        .innertd2 {
            padding: 0px 16pt;
        }

        .tc1 {
            background: linear-gradient(160deg, #7fbfff40 0%, #3f7fff20 100%);
        }

        .tc2 {
            transition: opacity 200ms cubic-bezier(.68,-0.55,.27,1.55);
            background: linear-gradient(145deg, #ff404070 0%, #ff404030 100%);
            opacity: .6;
        }

        .tc2:hover {
            opacity: 1;
        }

        .txac {
            display: block;
            text-align: center;
            width: 100%;
            white-space: nowrap;
        }

        thead td {
            border-radius: 9pt 9pt 0px 0px;
            height: 28pt;
        }

        tfoot td {
            border-radius: 0px 0px 9pt 9pt;
            height: 28pt;
        }

        input {
            position: absolute;
            opacity: 0;
            width: calc(70vw - 6px);
            height: 28pt;
            transform: translate(0px, -6px);
        }
        a {
            background: #0080ff40;
            border-radius: 4px;
            padding: 0px 3px;
            text-decoration: none;
            color: aqua;
        }
        hr {
            border: 0;
            background: linear-gradient(90deg, #fff0 0%, #ffff 50%, #fff0 100%);
            height: 4px;
            border-radius: 100%;
        }

        span.plgflgboxtc {
            vertical-align: middle;
        }
        span.plgflgbox {
            display: inline-table;
            border-radius: 4pt;
            background: linear-gradient(135deg, #fff2 0%, #fff0 100%);
            color: #ccc;
            text-align: center;
            width: 20pt;
            height: 20pt;
            font-size: 10pt;
            user-select: none;
            margin: 2pt;
        }
        .plgflgsev0 {
            background: linear-gradient(135deg, #0f05 0%, #0f01 100%)!important;
            color: #4c4!important;
        }
        .plgflgsev1 {
            background: linear-gradient(135deg, #0cf5 0%, #07f2 100%)!important;
            color: cyan!important;
        }
        .plgflgsev2 {
            background: linear-gradient(135deg, #ff04 0%, #f802 100%)!important;
            color: yellow!important;
        }
        .plgflgsev3 {
            background: linear-gradient(135deg, #f804 0%, #f002 100%)!important;
            color: #f80!important;
        }
        .plgflgsev4 {
            background: linear-gradient(135deg, #f044 0%, #f042 100%)!important;
            color: #f04!important;
        }
        .plgflgsev5 {
            background: linear-gradient(135deg, #80f8 0%, #f0f2 100%)!important;
            color: plum!important;
        }
        .note {color: #0ffa; font-size: 9.5pt;}

        @media only screen and (min-width: 1150px){
            input {
                width: 794px;
            }
            table, td {
                max-width: 800px;
            }

            td {
                max-width: 794px;
            }
            body {
                margin: 15vh calc(50vw - 400px);
            }
        }
        @media only screen and (min-width: 1920px){
            input {
                width: 1194px;
            }
            table, td {
                max-width: 1200px;
            }

            td {
                max-width: 1194px;
            }
            body {
                margin: 15vh calc(50vw - 600px);
                font-size: 18pt;
            }
            thead td, tfoot td, input {
                height: 42pt;
            }
            thead td {
                border-radius: 16pt 16pt 0px 0px;
            }

            tfoot td {
                border-radius: 0px 0px 16pt 16pt;
            }
            table {
                border-radius: 17pt;
            }
            span.plgflgbox {
                border-radius: 8pt;
                width: 30pt;
                height: 30pt;
                font-size: 15pt;
                margin: 4pt;
            }
            a {
                border-radius: 10pt;
                padding: 0pt 8pt;
            }
            .note {font-size: 14pt;}
        }
        @media only screen and (max-width: 640px){
            input {
                width: calc(96vw - 6px);
            }
            table, td {
                max-width: 96vw;
            }

            td {
                max-width: calc(96vw - 6px);
            }
            body {
                margin: 5vh 2vw;
            }
        }
    </style>
</head>

<body>
    <table width="100%" style="background-color: #111;" id="tab">
        <thead>
            <td class="tc1">
                <input type="file" id="fileIn" onchange="loadit()">
                <span class="txac" id="fileName"></span>
            </td>
        </thead>
    </table>
</body>
<script>
var reader = new FileReader;
var fname = document.getElementById("fileName")
var table = document.getElementById("tab")
clearTable()
function loadit() {
    reader.readAsArrayBuffer(fileIn.files[0]);
    reader.onload = function () {
        arraybuff = reader.result;
        file = new Uint8Array(arraybuff);
        filename = document.getElementById("fileIn").value;
        n = "";
        while (filename.length > 0 && filename.substring(filename.length - 1, filename.length) != "/" && filename.substring(filename.length - 1, filename.length) != "\\") {
            n = filename.substring(filename.length - 1, filename.length) + n;
            filename = filename.substring(0, filename.length - 1);
        }
        clearTable()
        fname.innerText = n
        load();
    }
}

function addLine(text) {
    tr = document.createElement("tr")
    td = document.createElement("td")
    td.classList.add("innertd")
    span = document.createElement("span")
    span.style = "white-space: normal; overflow-x: auto;"
    span.innerText = text
    td.appendChild(span)
    tr.appendChild(td)
    table.appendChild(tr)
}
function addLineH(text) {
    tr = document.createElement("tr")
    td = document.createElement("td")
    td.classList.add("innertd")
    span = document.createElement("span")
    span.style = "white-space: normal; overflow-x: auto;"
    span.innerHTML = text
    td.appendChild(span)
    tr.appendChild(td)
    table.appendChild(tr)
}
function endLine(text) {
    tr = document.createElement("tfoot")
    td = document.createElement("td")
    td.classList.add("tc2")
    sp = document.createElement("span")
    sp.classList.add("txac")
    sp.innerText = text
    td.onclick = clearTable
    td.appendChild(sp)
    tr.appendChild(td)
    table.appendChild(tr)
}
function clearTable() {
    while (table.children.length > 1)
        table.removeChild(table.children[1])
    fname.innerText = "Click here to upload a file"
}
function load() {
    addLineH("<br>")
    if (readstring(0,7)=="CYX$DMP0"){
        
        addLine("This is a CYX rescue dump.")
        addLineH('To extract it, use <a href="rescueDumpSaver.html">this tool</a> instead.')
    } else if (readstring(0,3)!="CY5%"){
        addLine("This is not a crash dump.")
    } else {
        version = readnum(4,5); // u16
        type = readnum(6,6); // u8
        lang = readnum(7,7); // u8
        ptcverOrig = readnum(8,11); // u32
        plgVer = readnum(12,15); // u32
        plgFlg = readnum(16,19); // u32

        addLine("Version: "+(version & 0x3FFF))
        addLine("Type: "+excepType(type))
        addLine("Language: "+parseLang(lang))
        addLine("Flags:")
        addPluginFlags(plgFlg)
        addLine("Plugin version: "+ptcver(plgVer))
        addLine("SB3 version: "+ptcver(ptcverOrig, lang))

        if (type & 0x8000) {
            // Is not a panic
            pc = readnum(20,23); // u32
            lr = readnum(24,27); // u32
            sp = readnum(28,31); // u32
            far = readnum(32,35); // u32
            callStack = Uint32Array(6); // u32 * 6
            for (i=0; i<callStack.length; i++) callstack[i] = readnum(36+i*4,39+i*4)
            prgn = Array(4); // string[15] * 4
            for (i=0; i<prgn.length; i++) prgn[i] = readstring(52+i*15,66+i*15)
        } else {
            // Is a panic, returns a string
            err = readstring(20,119).trim(); // string[100]
            addLineH("<hr>")
            addLine("Error message:")
            if (err!="")
                addLineH("<code>"+err+"</code>")
            else 
                addLineH("<span class=\"note\">Looks like the error string has been truncated.<br>The crash dump may have been modified. Take these results with a grain of salt!</span>")
        }
    }
    addLineH("<br>")
    endLine("Close")
}
function addPluginFlags(f=0){
    aFlags = {
         0: ["P", 5, "The plugin has panicked."],
         1: ["-", 9, ""],
         2: ["-", 9, ""],
         3: ["-", 9, ""],
         4: ["-", 9, ""],
         5: ["-", 9, ""],
         6: ["-", 9, ""],
         7: ["-", 9, ""],
         8: ["-", 9, ""],
         9: ["-", 9, ""],
        10: ["-", 9, ""],
        11: ["-", 9, ""],
        12: ["-", 9, ""],
        13: ["-", 9, ""],
        14: ["-", 9, ""],
        15: ["-", 9, ""],
        16: ["-", 9, ""],
        17: ["-", 9, ""],
        18: ["-", 9, ""],
        19: ["-", 9, ""],
        20: ["-", 9, ""],
        21: ["-", 9, ""],
        22: ["-", 9, ""],
        23: ["-", 9, ""],
        24: ["X", 3, "The user enabled the CYX API, which is currently experimental and may have caused the crash."],
        25: ["-", 9, ""],
        26: ["-", 9, ""],
        27: ["-", 9, ""],
        28: ["-", 9, ""],
        29: ["-", 9, ""],
        30: ["v", 2, "The user spoofed the SmileBASIC version."],
        31: ["E", 4, "The user has run an experiment. This may have caused the crash."]
    }
    if (f == 0) return
    __tr = document.createElement("tr")
    __td = document.createElement("td")
    __td.classList.add("innertd2")
    for (i=31; i>=0; i--){
        if (f & (1<<i)){
            _sp = document.createElement("span")
            _sp.classList.add("plgflgbox")
            _sp.classList.add("plgflgsev"+aFlags[i][1])
            _sptext = document.createElement("span")
            _sptext.classList.add("plgflgboxtc")
            _sptext.innerText = aFlags[i][0]
            _sp.appendChild(_sptext)
            if (aFlags[i][2]==""){
                _sp.title = "This flag is either not known or the crash dump was modified. Take the results with a grain of salt!"
            } else {
                _sp.title = aFlags[i][2]
            }
            __td.appendChild(_sp)
        }
    }
    __tr.appendChild(__td)
    table.appendChild(__tr)
}
function excepType(type=0){
    aTypes = [
        "Prefetch Abort",
        "Data Abort",
        "Undefined Instruction",
        "Floating Point Exception"
    ]
    if (type >= aTypes.length) return "Plugin Panic"
    return aTypes[type]
}
function parseLang(lang=0){
    s=""
    tLng = [
        "Japanese",
        "English",
        "French",
        "German",
        "Italian",
        "Spanish",
        "Simplified Chinese",
        "Korean",
        "Dutch",
        "Portuguese",
        "Russian",
        "Traditional Chinese"
    ]
    language = lang & 15
    if (language > tLng.length)
        return "["+language+"]"
    return tLng[language]
}
function ptcver(num=0, lng=-1){
    s = ""
    if (lng>=0){
        lng = (lng >> 4)&15
        tReg = ["[BAD] ","JPN ","USA ","EUR "]
        if (lng >= tReg.length)
            s += "UNK "
        else
            s += tReg[lng]
    }
    s +=
        ((num>>24)&255)+"."+
        ((num>>16)&255)+"."+
        ((num>> 8)&255)
    if (num & 255) s += "-"+(num & 255)
    return s
}
function downloadfile(file,n){
	var z = new Blob([file], {"type":"octet/stream"});
	document.getElementById("dl").href=URL.createObjectURL(z);
	document.getElementById("dl").download=n;
	if(!!navigator.msSaveBlob){
		navigator.msSaveBlob(z, n);
		return;
	}
	document.getElementById("dl").click();
}
function string_rjust(s, l=0, p=" "){
    while (s.length < l)
        s = p+s
    return s
}
function hex(st){
	return "0123456789ABCDEF".indexOf(st);
}
function hextoarray(s,pos){
	for(i=0;i<=(s.length-2)/3;i++){
		file[i+pos]=(hex(s.substring(i*3,i*3+1))*16+hex(s.substring(i*3+1,i*3+2)));
	}
}
function readnum(start,end){
	var number=0;
	for(var i=start;i<=end;i++){
		number+=Math.pow(256,(i-start))*file[i];
	}
	return number;
}
function insertnum(num,length,pos){
	for(var i=0;i<length;i++){
		file[i+pos]=(num & 255);
		num=(num-(num & 255))/256;
	}
}
function readstring(start,end){
	var stri="";
	for(var i=start;i<=end;i++){
		if(file[i]!=0)
            stri=stri+String.fromCharCode(file[i]);
        else
            break
	}
	return stri;
}
</script>

</html>